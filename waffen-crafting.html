<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Waffen Crafting-System - Lostparadise.eu</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/BattleNogare/lostparadise-herstellung/main/favicon-96x96.png" />

  <style>
    :root{
      --bg:#0d1117;
      --panel:#151b23;
      --ink:#f0f0f0;
      --muted:#97a3b6;
      --border:#666;
      --accent:#ffd700;
      --panel-2:#2e2e2e;
    }

    body{
      font-family:Arial,system-ui;
      margin:2rem;
      background:var(--bg);
      color:var(--ink);

      /* Waffen-Hintergrund */
      background-image:url('https://raw.githubusercontent.com/BattleNogare/lostparadise-herstellung/main/Lostparadise-CraftingWaffen2.png');
      background-size:contain;
      background-repeat:no-repeat;
      background-position:center;
      background-attachment:fixed;
    }

    .kopfzeile{
      display:flex;
      align-items:center;
      gap:1rem;
    }
    .kopfzeile img{
      height:80px;
      width:auto;
      object-fit:contain;
    }

    .link-button {
      display:inline-block;
      padding:.6rem 1rem;
      background-color:var(--panel);
      color:var(--accent);
      text-decoration:none;
      border:1px solid var(--border);
      border-radius:5px;
      transition:background-color .3s ease,color .3s ease;
    }
    .link-button:hover{
      background-color:var(--accent);
      color:var(--panel);
    }

    .controls{
      display:flex;
      gap:1rem;
      align-items:flex-end;
      margin:.5rem 0 1rem;
      flex-wrap:wrap;
    }

    .controls select{
      flex:1 1 48%;
      max-width:48%;
      min-width:320px;
      font-size:1rem;
      padding:.6rem .75rem;
      background:var(--panel);
      color:#fff;
      border:1px solid var(--border);
      border-radius:8px;
    }
    .controls select:focus{
      outline:2px solid var(--accent);
      outline-offset:2px;
    }

    .hinweis-box{
      background:var(--panel-2);
      color:var(--accent);
      padding:1rem;
      border-left:5px solid var(--accent);
      margin:0 0 1rem;
      width:100%;
      border-radius:6px;
      white-space:pre-wrap;
    }
    .error-box{
      color:#ff9aa2;
    }

    .ausgabe-wrapper{
      display:flex;
      gap:2rem;
      align-items:flex-start;
      flex-wrap:wrap;
      margin-top:0;
    }
    .ausgabe-wrapper>*{
      margin-top:0;
    }
    .col{
      flex:1 1 48%;
      max-width:48%;
      min-width:320px;
    }

    pre{
      background:var(--panel-2);
      padding:1rem 1.25rem;
      white-space:pre-wrap;
      border:1px solid var(--border);
      border-radius:10px;
      line-height:1.45;
      min-height:280px;
      font-family:ui-monospace,Menlo,Consolas,"Liberation Mono",monospace;
    }

    #bilderContainer img{
      display:block;
      max-width:100%;
      height:auto;
      margin-bottom:1rem;
      border:3px double #ccc;
      border-radius:8px;
      background:#1b1f24;
      box-shadow:0 0 10px rgba(0,255,255,.2);
      object-fit:contain;
    }

    @media (max-width:1100px){
      .controls select{
        flex-basis:100%;
        max-width:100%;
        min-width:0;
      }
      .hinweis-box{
        width:100%;
      }
      .col{
        flex-basis:100%;
        max-width:100%;
        min-width:0;
      }
    }
  </style>
</head>
<body>

  <!-- Kopfzeile -->
  <div class="kopfzeile">
    <img src="https://raw.githubusercontent.com/BattleNogare/lostparadise-herstellung/main/Lostparadise-CraftingWaffen2.png" alt="Lostparadise.eu Waffen Logo" />
    <h1>Lostparadise.eu - Waffen - Crafting-System</h1>
  </div>

  <!-- Zur Fahrzeug-Seite -->
  <p>
    <a href="index.html" class="link-button">Zum Fahrzeug-Crafting</a>
  </p>

  <!-- Nur EIN Dropdown f√ºr Zielprodukt -->
  <div class="controls">
    <select id="endSelect" disabled>
      <option value="">-- Zielprodukt ausw√§hlen --</option>
    </select>
  </div>

  <!-- Hinweis -->
  <div class="hinweis-box" id="hintBox">
    üí° Hinweis!  
    Die Werte sind berechnet und nicht garantiert!  
    Verwendung auf eigene Gefahr.  
    üîÑ Lade Daten aus Google Sheets ‚Ä¶
  </div>

  <!-- Ausgabe-Bereich -->
  <div class="ausgabe-wrapper">
    <div class="col">
      <pre id="ausgabe">Bitte Zielprodukt ausw√§hlen.</pre>
    </div>
    <div class="col" id="bilderContainer"></div>
  </div>

<script>
/* ========= Konfig ========= */
const SHEET_ID = "1ObAKUBNv5IjXEyY0TD85gK9dJhlm8Uq7Qj6QZgHkoZg";
const TAB_RECIPES = "recipes";
const TAB_ITEMS   = "recipe_items";
const TAB_TRANSL  = "translate";
const TAB_PRICES  = "prices";

/* Waffen-Crafting == Bucket 3 */
const DEFAULT_BUCKETS = [3];

/* ========= State ========= */
const endSelect   = document.getElementById("endSelect");
const ausgabe     = document.getElementById("ausgabe");
const hintBox     = document.getElementById("hintBox");
const bilderContainer = document.getElementById("bilderContainer");

const rezepte = {};
const baseNames = {};
const translateMap = {};
const displayNameCache = new Map();

const baseItemKeys = new Set();
const rohstoffPreise = {};

let allowedBuckets = new Set(DEFAULT_BUCKETS);
let allDropdownCandidates = [];

/* ========= Utils ========= */
function normKey(v){
  return String(v ?? "")
    .normalize("NFKC")
    .replace(/[\u00A0\u200B\t\n\r]+/g,"")
    .replace(/\s+/g," ")
    .trim()
    .replace(/[;:]+$/,"")
    .toLowerCase();
}

function parseEuroNumber(v){
  if(v==null) return NaN;
  if(typeof v==="number" && isFinite(v)) return v;
  let s=String(v).trim();
  if(!s) return NaN;
  s=s.replace(/[^\d.,-]/g,'');
  if(!/[.,]/.test(s)) return Number(s);

  const d=s.lastIndexOf('.');
  const c=s.lastIndexOf(',');
  const decIsComma = c > d;

  if(decIsComma){
    s=s.replace(/\./g,'');
    const i=s.lastIndexOf(',');
    s=s.slice(0,i).replace(/,/g,'') + '.' + s.slice(i+1).replace(/,/g,'');
  } else {
    s=s.replace(/,/g,'');
  }
  const n=Number(s);
  return isFinite(n)?n:NaN;
}

function displayName(k){
  if(!k) return "";
  if(displayNameCache.has(k)) return displayNameCache.get(k);
  const n=translateMap[k] || baseNames[k] || k;
  displayNameCache.set(k,n);
  return n;
}

function fillDropdown(sel,keys){
  const prev = sel.value;
  sel.innerHTML = "";

  const first = document.createElement("option");
  first.value = "";
  first.textContent = "-- Zielprodukt ausw√§hlen --";
  sel.appendChild(first);

  for(const k of keys){
    const opt = document.createElement("option");
    opt.value = k;
    opt.textContent = displayName(k);
    sel.appendChild(opt);
  }

  if(prev && keys.includes(prev)) sel.value=prev;
}

function gvizJSONP(sheetName, timeoutMs=15000){
  return new Promise((resolve,reject)=>{
    const cb="gvizCb_"+Math.random().toString(36).slice(2);
    const url=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json,responseHandler:${cb}&headers=1&sheet=${encodeURIComponent(sheetName)}`;
    const script=document.createElement("script");

    let to=setTimeout(()=>{
      cleanup();
      reject(new Error("Timeout "+sheetName));
    },timeoutMs);

    function cleanup(){
      clearTimeout(to);
      try{ delete window[cb]; }catch(_){}
      if(script.parentNode) script.parentNode.removeChild(script);
    }

    window[cb]=p=>{
      cleanup();
      try{
        const cols=p.table.cols.map(c=>(c.label||c.id||"").trim());
        const rows=p.table.rows.map(r=>{
          const o={};
          (r.c||[]).forEach((cell,i)=>{
            o[cols[i]||("c"+i)] = cell ? cell.v : "";
          });
          return o;
        });
        resolve(rows);
      }catch(e){
        reject(e);
      }
    };

    script.src=url;
    script.onerror=()=>{
      cleanup();
      reject(new Error("GViz error "+sheetName));
    };
    document.head.appendChild(script);
  });
}

/* ===== Mapping-Helfer ===== */
function buildInverseTranslateForBase(){
  const map=new Map(); // display(lower) -> internal
  for(const key of baseItemKeys){
    const disp=translateMap[key];
    if(disp) map.set(String(disp).toLowerCase(), key);
  }
  return map;
}

const PRICE_ALIASES = new Map([
  ["plastic","kunststoff"],
  ["rubber","gummi"],
  ["cotton","baumwolle"]
]);

function mapAnyKeyToInternal(raw, invMap){
  const n = normKey(raw);
  if(!n) return "";

  // 1) bereits interner Key?
  if(baseItemKeys.has(n) || rezepte[n]) return n;

  // 2) display ‚Üí internal
  const viaDisplay = invMap.get(n.toLowerCase());
  if(viaDisplay) return viaDisplay;

  // 3) bekannte Aliase
  const alias = PRICE_ALIASES.get(n);
  if(alias) return alias;

  return n;
}

/* Preise erkennen */
function scanPriceRowForPairs(row, invMap){
  const keys = Object.keys(row);
  for(let i=0; i<keys.length-1; i++){
    const keyItem  = keys[i];
    const keyPrice = keys[i+1];

    const rawItem  = row[keyItem];
    const rawPrice = row[keyPrice];
    if(rawItem===undefined || rawItem==="" ||
       rawPrice===undefined || rawPrice==="") continue;

    const internal = mapAnyKeyToInternal(rawItem, invMap);
    const val = parseEuroNumber(rawPrice);

    if(!internal || !isFinite(val) || val < 1) continue;
    if(!baseItemKeys.has(internal)) continue;

    rohstoffPreise[internal] = Math.round(val);
  }
}

/* ========= Daten laden ========= */
async function ladeDaten(){
  try{
    hintBox.textContent =
      "üí° Hinweis!\n" +
      "Die Werte sind berechnet und nicht garantiert!\n" +
      "Verwendung auf eigene Gefahr.\n" +
      "üîÑ Lade Daten ...";

    const [recipesRows,itemsRows,transRows,pricesRows] = await Promise.all([
      gvizJSONP(TAB_RECIPES),
      gvizJSONP(TAB_ITEMS),
      gvizJSONP(TAB_TRANSL).catch(()=>[]),
      gvizJSONP(TAB_PRICES).catch(()=>[])
    ]);

    /* translate */
    for(const r of transRows){
      const ks=Object.keys(r);
      const internal=normKey(r.internal||r.key||r.item||r[ks[0]]);
      const display =String(r.display||r.name||r[ks[1]]||"").trim();
      if(internal && display){
        translateMap[internal]=display;
      }
    }

    /* recipes */
    const passed = new Set();
    for(const r of recipesRows){
      const k=normKey(r.key);
      if(!k) continue;

      baseNames[k]=String(r.name??"").trim()||k;

      rezepte[k]={
        wert:Number(r.wert??0)||0,
        picture:String(r.picture??"").trim(),
        itemsRequired:[]
      };

      const sel=Number(r.selectable);
      if(new Set(DEFAULT_BUCKETS).has(sel)){
        passed.add(k);
      }
    }

    /* recipe_items + Basisrohstoffe markieren */
    const byProd={};
    for(const r of itemsRows){
      const p=normKey(r.product);
      const i=normKey(r.item);
      const q=Number(r.qty??0)||0;
      if(!p||!i||!q) continue;
      (byProd[p]??=[]).push([i,q]);
    }

    for(const k of Object.keys(rezepte)){
      const arr = byProd[k]||[];
      rezepte[k].itemsRequired = arr;
      for(const [dep] of arr){
        if(!rezepte[dep]){
          baseItemKeys.add(dep);
        }
      }
    }

    /* Preise aufl√∂sen */
    const invMap=buildInverseTranslateForBase();
    for(const row of pricesRows){
      scanPriceRowForPairs(row, invMap);
    }

    /* Dropdown bef√ºllen */
    allDropdownCandidates = Array.from(passed).sort((a,b)=>{
      const na = Number(a.replace(/\D+/g,""))||0;
      const nb = Number(b.replace(/\D+/g,""))||0;
      return na-nb || a.localeCompare(b);
    });

    fillDropdown(endSelect, allDropdownCandidates);
    endSelect.disabled=false;

    hintBox.textContent =
      "üí° Hinweis!\n" +
      "Die Werte sind berechnet und nicht garantiert!\n" +
      "Verwendung auf eigene Gefahr.\n" +
      "‚úÖ Daten geladen.";
  }catch(e){
    console.error(e);
    hintBox.classList.add("error-box");
    hintBox.textContent="‚ùå "+e.message;
  }
}

/* ========= Berechnung / Anzeige ========= */

/* Rohstoff√ºbersicht rekursiv */
function sammleRohstoffe(item,m,bag){
  const r=rezepte[item];
  if(!r) return;

  for(const [dep,q] of (r.itemsRequired||[])){
    const tot=q*m;
    if(rezepte[dep]){
      // Zwischenprodukt weiter aufl√∂sen
      sammleRohstoffe(dep, tot, bag);
    } else {
      // Basisrohstoff
      if(!bag[dep]) {
        bag[dep]={menge:0,verwendetIn:{}};
      }
      bag[dep].menge+=tot;
      const zielName = displayName(item);
      bag[dep].verwendetIn[zielName] =
        (bag[dep].verwendetIn[zielName]||0)+tot;
    }
  }
}

/* Herstellprozess / Reihenfolge */
function baueHerstellprozess(target){
  const qty = {};
  const edges = {};
  const nodes = new Set();

  function addEdge(d,t){
    (edges[d]??=new Set()).add(t);
  }

  function collect(it,m){
    const r=rezepte[it];
    if(!r) return;
    nodes.add(it);

    for(const[dep,x] of (r.itemsRequired||[])){
      const need=x*m;
      if(rezepte[dep]){
        addEdge(dep,it);
        nodes.add(dep);
        qty[dep]=(qty[dep]||0)+need;
        collect(dep,need);
      }
    }
  }

  collect(target,1);

  // Toposort
  const indeg={};
  for(const n of nodes){
    indeg[n]=0;
  }
  for(const d in edges){
    for(const t of edges[d]){
      if(nodes.has(t)){
        indeg[t]=(indeg[t]||0)+1;
      }
    }
  }

  const q=[];
  for(const n of nodes){
    if((indeg[n]||0)===0) q.push(n);
  }

  const topo=[];
  while(q.length){
    const n=q.shift();
    topo.push(n);
    if(edges[n]){
      for(const t of edges[n]){
        indeg[t]--;
        if(indeg[t]===0) q.push(t);
      }
    }
  }

  if(!topo.includes(target)) topo.push(target);

  let txt="üîß Herstellprozesse (Abarbeitungsreihenfolge):\n";
  for(const it of topo){
    const amount = (it===target)?1:(qty[it]||0);
    if(amount<=0 && it!==target) continue;

    txt+=`- ${amount}x ${displayName(it)}\n`;
    const r=rezepte[it];
    if(!r) continue;
    for(const[dep,m] of (r.itemsRequired||[])){
      txt+=`    ‚§∑ ${m*amount}x ${displayName(dep)}\n`;
    }
  }
  return txt;
}

function updateAnzeige(){
  const ziel = normKey(endSelect.value||"");
  if(!ziel){
    ausgabe.textContent="Bitte Zielprodukt ausw√§hlen.";
    bilderContainer.innerHTML="";
    return;
  }

  // Rohstoffe + Kosten
  const bag={};
  sammleRohstoffe(ziel,1,bag);

  let roh="üì¶ Rohstoffliste:\n";
  let sum=0;
  for(const k in bag){
    const e=bag[k];
    const p=rohstoffPreise[k]||0;
    const c=Math.round(p*e.menge);

    roh+=`- ${e.menge}x ${displayName(k)} ${p.toLocaleString('de-DE')} ‚Ç¨/St = ${c.toLocaleString('de-DE')} ‚Ç¨\n`;

    for(const v in e.verwendetIn){
      roh+=`    ‚Ü≥ verwendet in: ${v} (${e.verwendetIn[v]})\n`;
    }
    sum+=c;
  }

  const proc = baueHerstellprozess(ziel);

  ausgabe.textContent =
    `üîÑ Pfad: ${displayName(ziel)}\n\n` +
    roh +
    `\nüí∞ Gesamtkosten: ${sum.toLocaleString('de-DE')} ‚Ç¨\n\n` +
    proc;

  // Bilder anzeigen
  bilderContainer.innerHTML="";
  const r=rezepte[ziel];
  if(r && r.picture){
    const urls=r.picture
      .split(";")
      .map(s=>s.trim())
      .filter(s=>/^https?:\/\//i.test(s));

    for(const url of urls){
      const img=document.createElement("img");
      img.src=url;
      img.alt=displayName(ziel);
      bilderContainer.appendChild(img);
    }
  }
}

/* ========= Events & Init ========= */
endSelect.addEventListener("change", updateAnzeige);

/* Startdaten laden */
ladeDaten();
</script>
</body>
</html>
